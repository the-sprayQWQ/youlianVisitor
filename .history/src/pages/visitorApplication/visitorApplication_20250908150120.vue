<!-- 使用 type="ho
  components: { SubmitBtn },
  components: { BusinessForm },me" 属性设置首页，其他页面不需要设置，默认为page -->
<route lang="jsonc">
{
  "style": {
    // 'custom' 表示开启自定义导航栏，默认 'default'
    "navigationStyle": "default",
    "navigationBarTitleText": "访客入厂申请单",
  },
}
</route>

<script lang="ts" setup>
import type * as visitor from '../../interface/visitorApplicationInterface'
import { onLoad } from '@dcloudio/uni-app'
import { reactive, ref } from 'vue'
import { submitApplication } from '@/api/application'
import { getYlfkApplicationDetail, toApprovalApplication } from '@/api/role'
import SubmitBtn from '../../components/SubmitBtn/SubmitBtn.vue'

const studyFormRef = ref(null)
const businessFormRef = ref(null)
const userStore = useUserStore()
const currentLoginedUser = userStore.userInfo.userInfo.id

const initData = {
  applicationCode: '',
  applicationType: '1',
  user: '',
  transUser: '',
  userOpinion: '',
  applicationResult: '',
  ylfkApplicationPage: {
    user: '',
    phone: '',
    idCard: '',
    startTime: '',
    endTime: '',
    applicationDept: '',
    visitorDept: '',
    visitorUser: '',
    visitorPhone: '',
    remark: '',
    joinUserNum: '1',
    isCard: '是',
    carCode: '',
    isGoods: '',
    carImage: '',
    goodsImage: '',
    ylfkApplicationUserList: [
      {
        name: '',
        phone: '',
        cardType: '',
        idCard: '',
        visitorNumber: '',
        applicationStatus: '',
        carNumber: '',
        enterTime: '',
        leaveTime: '',
      },
    ],
  },
  ylfkCheckApplicationPage: {
    deptName: '',
    user: '',
    idCard: '',
    phone: '',
    belongDept: '',
    allUsers: '',
    isCar: '',
    carCode: '',
    checkHaveGoodsList: [
      {
        toolName: '',
        num: '',
        isLeave: '',
      },
    ],
    checkUsersList: [
      {
        name: '',
        cardCode: '',
        phone: '',
        insurance: '',
      },
    ],
  },
}

function deepClone(obj) {
  return JSON.parse(JSON.stringify(obj))
}

const form = ref(deepClone(initData))

const visitorTypes = ref<visitor.VisitorType[]>([
  { label: '学习交流', value: '1' },
  { label: '业务沟通', value: '0' },
])

const selectedVisitorType = ref<visitor.VisitorType>(visitorTypes.value[0])
const showDialog = ref<boolean>(false)
const showReject = ref<boolean>(false)
const showTransfer = ref<boolean>(false)
const showApproval = ref<boolean>(false)
const rejectReason = ref<string>('')

const approvals = ref<visitor.Approvals>({
  manager: false,
  leader: false,
  guard: false,
})

async function onVisitorTypeChange(e: any) {
  selectedVisitorType.value = visitorTypes.value[e.detail.value]
  form.value.applicationType = selectedVisitorType.value.value
  console.log(e.target.value)
  if (e.target.value === '0') {
    await nextTick()
    await studyFormRef.value.getDepartList()
  }
  else {
    await nextTick()
    await businessFormRef.value.getDepartList()
  }
}

function onApprovalChange(e: any) {
  // console.log(e, 'type e')
  // console.log('onApprovalChange 被调用', type, e.detail.value)
  // approvals.value[type] = e.detail.value
  // console.log(approvals.value[type], 'value')
}

function showVisitorTypeDialog() {
  showDialog.value = true
}

function onReject() {
  showReject.value = true
}

function onTransfer() {
  showTransfer.value = true
}

function onApprove() {
  showApproval.value = true
}

const value = ref<number[]>([])

function closePopup(data) {
  console.log(data)
  showReject.value = data
}

function closeDialog(data) {
  showDialog.value = data
}

function closeTransferPopup(data) {
  showTransfer.value = data
}

const columns = ref([
  '选项1',
  '选项2',
  '选项3',
  '选项4',
  '选项5',
  '选项6',
  '选项7',
])
const value1 = ref('')
const isShow = ref(false)
function handleConfirm1({ value }) {
  value1.value = value
}

function closeApprovalPopup() {
  showApproval.value = false
}
const applyId = ref('')
const timeStampList = ref<number[]>([])
const disable = ref(false)
const managerApp = ref(false)
function getTimeStamp(dateString: string) {
  return new Date(dateString).getTime()
}
onLoad(async (e) => {
  if (e.applyId && e.applyId !== 'undefined') {
    applyId.value = e.applyId
    const res = await getYlfkApplicationDetail(e.applyId, e.applicationType)
    if (res.code === 200) {
      form.value = res.result

      timeStampList.value = [
        getTimeStamp(form.value.ylfkApplicationPage.startTime),
        getTimeStamp(form.value.ylfkApplicationPage.endTime),
      ]
      if (form.value.applicationType === '0') {
        selectedVisitorType.value = visitorTypes.value[1]
      }
      else {
        selectedVisitorType.value = visitorTypes.value[0]
      }
    }
    if (e.roleType === '访客') {
      disable.value = true
    }
  }
  if (e.roleType === '访客') {
    isShow.value = false
  }
  else if (e.roleType === '部门审核') {
    disable.value = true
    managerApp.value = true
    isShow.value = true
  }
  else {
    isShow.value = true
  }
})

async function submit() {
  console.log(form.value)
  const res = await submitApplication(form.value)
  if (res.code === 200) {
    uni.showToast({
      title: '提交成功',
      icon: 'success',
      duration: 2000,
    })
    setTimeout(() => {
      uni.switchTab({ url: '/pages/index/index' })
    }, 2000)
  }
}

async function Approval(form) {
  const res = await toApprovalApplication(form)
  if (res.code === 200) {
    uni.switchTab({
      url: '/pages/audit/audit',
    })
  }
}
const form1 = {
  user: '',
  applicationCode: '',
  applicationType: '',
  transUser: '',
  copyUser: '',
  userOpinion: '',
  applicationResult: '',
}
async function confirmApproval() {
  form1.user = currentLoginedUser
  form1.applicationCode = applyId.value
  if (approvals.value.manager === true) {
    form1.userOpinion = '同意入厂'
  }
  form1.copyUser = value1.value
  form1.applicationResult = '0'
  await Approval(form1)
}
async function confirmReject() {
  form1.user = currentLoginedUser
  form1.applicationCode = applyId.value
  form1.userOpinion = rejectReason.value
  form1.applicationResult = '1'
  await Approval(form1)
}
</script>

<template>
  <view class="container">
    <view class="box-border p-3">
      <view v-if="applyId" class="form-row-number">
        <text class="form-label">申请单号</text>
        <text class="form-value text-primary">{{ applyId }}</text>
      </view>

      <!-- 访客类型 -->
      <view class="form-group">
        <view class="form-row">
          <text class="form-label required">访客类型</text>
          <view i-tabler:help @click="showVisitorTypeDialog" />
        </view>
        <view class="select-wrapper">
          <picker
            mode="selector"
            :range="visitorTypes"
            range-key="label"
            :disabled="disable"
            @change="onVisitorTypeChange"
          >
            <view class="select-input">
              <text>{{ selectedVisitorType.label }}</text>
            </view>
          </picker>
        </view>
      </view>
    </view>

    <!-- 主体部分 -->
    <scroll-view class="content" scroll-y>
      <study-form
        v-show="selectedVisitorType.value === '1'"
        ref="studyFormRef"
        :form="form"
        :apply-id="applyId"
        :disabled="disable"
        :value="timeStampList"
      />
      <business-form
        v-show="selectedVisitorType.value === '0'"
        ref="businessFormRef"
        :disabled="disable"
        :apply-id="applyId"
        :form="form"
        :value="timeStampList"
      />
    </scroll-view>

    <!-- 审批框 -->
    <view v-if="applyId && isShow" class="mb-12 box-border p-3">
      <view class="approval-section">
        <view v-if="managerApp" class="approval-item">
          <text class="approval-title">经理意见</text>
          <label class="approval-checkbox">
            <wd-checkbox v-model="approvals.manager"> 同意入厂 </wd-checkbox>
            <!-- <text class="approval-text">同意入厂</text> -->
          </label>
        </view>

        <view v-if="!managerApp" class="approval-item">
          <text class="approval-title">分管领导意见</text>
          <label class="approval-checkbox">
            <wd-checkbox v-model="approvals.leader"> 同意入厂 </wd-checkbox>
          </label>
        </view>

        <view v-if="!managerApp" class="approval-item-extra">
          <view style="display: flex; justify-content: space-between">
            <text class="approval-title">门卫审批</text>
            <label class="approval-checkbox">
              <wd-checkbox v-model="approvals.guard"> 已阅 </wd-checkbox>
            </label>
          </view>

          <view class="guard-info">
            <view class="info-item">
              <text class="info-label">临时访客证号</text>
              <view class="info-value">
                <text>V2508080001</text>
              </view>
            </view>
            <view class="info-item">
              <text class="info-label">临时车牌号</text>
              <view class="info-value">
                <text>T2508080001</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <FooterBtn
      v-if="applyId && isShow"
      @reject="onReject"
      @transfer="onTransfer"
      @approve="onApprove"
    />
    <submit-btn v-if="!applyId" @submit="submit" />
    <!-- 问号弹窗 -->
    <Dialog v-if="showDialog" @close-popup="closeDialog">
      <template #title>
        <text class="dialog-title">访客类型说明</text>
      </template>
      <template #content>
        <text class="dialog-text">访客类型说明：学习交流场景定义...</text>
      </template>
    </Dialog>

    <!-- 驳回弹窗 -->
    <Dialog v-if="showReject" @close-popup="closePopup">
      <template #title>
        <text class="dialog-title">确定要驳回吗?</text>
      </template>
      <template #content>
        <wd-textarea v-model="rejectReason" placeholder="请填写理由" />
        <ButtonGroup
          :show-reject="showReject"
          type="error"
          @close-popup="closePopup"
          @confirm="confirmReject"
        />
      </template>
    </Dialog>

    <!-- 转办弹窗 -->
    <Dialog v-if="showTransfer" @close-popup="closeTransferPopup">
      <template #title>
        <text class="dialog-title">请选择转办人</text>
      </template>
      <template #content>
        <wd-picker
          v-model="value"
          :columns="columns"
          @confirm="handleConfirm1"
        />
        <ButtonGroup
          :show-reject="showTransfer"
          type="primary"
          @close-popup="closeTransferPopup"
        />
      </template>
    </Dialog>

    <!-- 通过弹窗 -->
    <Dialog v-if="showApproval" @close-popup="closeApprovalPopup">
      <template #title>
        <text class="dialog-title">确定要通过吗?</text>
      </template>
      <template #content>
        <text class="text-sm text-#a3a8b9">抄送人(选填)</text>
        <wd-picker
          v-model="value"
          :columns="columns"
          @confirm="handleConfirm1"
        />
        <ButtonGroup
          :show-reject="showApproval"
          type="success"
          @close-popup="closeApprovalPopup"
          @confirm="confirmApproval"
        />
      </template>
    </Dialog>
  </view>
</template>

<style scoped lang="scss">
page {
  min-height: 100%;
}

.container {
  display: flex;
  flex-direction: column;
  min-height: 100%;
  background-color: #ffffff;
}

.content {
  flex: 1;
  //   overflow: auto;
}

.form {
  &-section {
    padding: 24rpx;
    padding-top: 0;
  }

  &-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16rpx;
  }
  &-row-number {
    display: flex;
    justify-content: space-between;
    // width: 650rpx;
    margin: 0 auto;
    height: 80rpx;
    background-color: #f9fafb;
    border: 1px solid #f9fafb;
    align-items: center;
    border-radius: 20rpx;
    margin-bottom: 10rpx;
    & .form-label {
      font-size: 14px;
      color: #8b97a7;
      margin-left: 20rpx;
    }
    & .form-value {
      font-size: 14px;
      color: #8b97a7;
      margin-right: 20rpx;
    }
  }

  &-label {
    font-size: 14px;
    color: #4e5969;
  }

  &-value {
    font-size: 14px;
  }

  &-group {
    margin-bottom: 24rpx;
  }

  &-grid {
    display: flex;
    gap: 20rpx; // 保持你原有的40rpx间距
    margin-bottom: 16rpx;
  }

  &-item {
    flex: 1;
  }

  &-input {
    height: 64rpx;
    border: 1px solid #e5e7eb;
    border-radius: 4rpx;
    padding: 0 24rpx;
    font-size: 14px;
    color: #1d2129;
    width: 100%;
    box-sizing: border-box; // 确保padding不影响总宽度
    z-index: 1;
  }
}
.select {
  &-wrapper {
    position: relative;
  }

  &-input {
    height: 64rpx;
    border: 1px solid #e5e7eb;
    border-radius: 4rpx;
    padding: 0 24rpx;
    font-size: 14px;
    color: #1d2129;
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    box-sizing: border-box; // 确保宽度一致
  }
}

.approval {
  &-item {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 8rpx;
    padding: 24rpx;
    margin-bottom: 16rpx;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    display: flex; // 使用flex布局
    justify-content: space-between; // 左右对称
    align-items: center; // 垂直居中
  }
  &-item-extra {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 8rpx;
    padding: 24rpx;
    margin-bottom: 16rpx;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  &-title {
    font-size: 14px;
    font-weight: 500;
    color: #1d2129;
  }

  &-checkbox {
    display: flex;
    align-items: center;
  }

  &-text {
    font-size: 14px;
    font-weight: 500;
    color: #165dff;
    margin-left: 8rpx;
  }
}

.guard-info {
  margin-top: 16rpx;
}

.info {
  &-item {
    margin-bottom: 16rpx;

    &:last-child {
      margin-bottom: 0;
    }
  }

  &-label {
    font-size: 14px;
    color: #4e5969;
    margin-bottom: 8rpx;
    display: block;
  }

  &-value {
    height: 64rpx;
    background-color: #f5f7fa;
    border-radius: 4rpx;
    padding: 0 24rpx;
    font-size: 14px;
    color: #1d2129;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
}

.dialog {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;

  &-content {
    background-color: #ffffff;
    border-radius: 16rpx;
    width: 80%;
    max-width: 600rpx;
    padding: 32rpx;
  }

  &-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24rpx;
  }

  &-title {
    font-size: 16px;
    font-weight: 500;
    color: #1d2129;
  }

  &-text {
    font-size: 14px;
    color: #4e5969;
  }
}

.required {
  &::after {
    content: '*';
    color: #ff4d4f;
    margin-left: 4rpx;
  }
}

.text-primary {
  color: #165dff;
}
</style>
