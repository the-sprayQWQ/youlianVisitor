<route lang="jsonc">
{
  "style": {
    // 'custom' 表示开启自定义导航栏，默认 'default'
    "navigationStyle": "default",
    "navigationBarTitleText": "员工核验申请",
  },
}
</route>

<script lang="ts" setup>
import { onBackPress } from '@dcloudio/uni-app'
import { computed, onMounted, ref, watch } from 'vue'
import { submitApplication } from '@/api/application'
import { getYlfkApplicationDetail, toApprovalApplication } from '@/api/role'
import { getApprovalResult, getSysAllUserList } from '@/api/sys'
import { getAllDepartment } from '../../api/sys'
import { uploadFileUrl, useUpload } from '../../utils/uploadFile'

const baseUrl = import.meta.env.VITE_SERVER_BASEURL
const employeeUploaders = ref({})
const userStore = useUserStore()
const currentLoginedUser = userStore.userInfo.userInfo.id
const currentDepartment = userStore.userInfo?.departs?.[0]?.departName || ''

// 生成申请单号
function generateApplicationNumber() {
  const date = new Date()
  const year = date.getFullYear()
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  const random = Math.floor(Math.random() * 900 + 100)
  return `${year}${month}${day}${random}`
}

const initData = {
  applicationCode: '',
  applicationType: '2',
  user: '',
  transUser: '',
  userOpinion: '',
  applicationResult: '',
  hrApproval: false,
  adminApproval: false,
  ylfkApplicationPage: {
    user: '',
    phone: '',
    idCard: '',
    startTime: '',
    endTime: '',
    applicationDept: '',
    visitorDept: '',
    visitorUser: '',
    visitorPhone: '',
    remark: '',
    joinUserNum: '1',
    isCard: '是',
    carCode: '',
    isGoods: '',
    carImage: '',
    goodsImage: '',
    ylfkApplicationUserList: [
      {
        name: '',
        phone: '',
        cardType: '',
        idCard: '',
        visitorNumber: '',
        applicationStatus: '',
        carNumber: '',
        enterTime: '',
        leaveTime: '',
      },
    ],
  },
  ylfkCheckApplicationPage: {
    deptName: '',
    user: '',
    idCard: '',
    phone: '',
    belongDept: '',
    allUsers: '',
    isCar: false,
    carCode: '',
    isHaveGoods: false,
    goodsInfo: '',
    checkUsersList: [
      {
        name: '',
        cardCode: '',
        phone: '',
        insurance: '',
      },
    ],
  },
}
function deepClone(obj) {
  return JSON.parse(JSON.stringify(obj))
}

const form = ref(deepClone(initData))

const form1 = {
  user: '',
  applicationCode: '',
  applicationType: '',
  transUser: '',
  copyUser: '',
  userOpinion: '',
  applicationResult: '',
  visitorNumber: '',
  carNumber: '',
  carImage: '',
  goodsImage: '',
}

const applicationNumber = ref('')
const uploadedFileName = ref('')

const approvals = ref({
  manager: false,
  leader: false,
  guard: false,
  hr: false,
  admin: false,
  guardEnter: false,
  guardReturnPass: false,
  guardExit: false,
})

const employeeTypes = ref([
  { label: '分包商员工', value: '分包商员工' },
  { label: '外协员工', value: '外协员工' },
  { label: '船东委外员工', value: '船东委外员工' },
])

const employeeType = ref({ label: '', value: '' })

const departments = ref([])

const department = ref({ label: '', value: '' })

// 初始化
onMounted(() => {
  applicationNumber.value = generateApplicationNumber()
})

// 返回
function goBack() {
  uni.navigateBack()
}

// 监听返回按钮
onBackPress(() => {
  goBack()
  return true
})

// 人员类型选择
function onEmployeeTypeChange(e: any) {
  employeeType.value = employeeTypes.value[e.detail.value]
  form.value.ylfkCheckApplicationPage.userType = employeeType.value.value
}

async function getResult(code: string) {
  const res = await getApprovalResult(code)
  if (res.code === 200) {
    opinionsList.value = res.result
  }
}

// 部门选择
function onDepartmentChange(e: any) {
  department.value = departments.value[e.detail.value]
  form.value.ylfkCheckApplicationPage.belongDept = department.value.value
}

// 导入Excel
function importExcel() {
  console.log('导入Excel')
}

// 下载文件
function downloadFile() {
  console.log('ok')
}

// 添加员工
function addEmployee() {
  form.value.ylfkCheckApplicationPage.checkUsersList.push({
    name: '',
    cardCode: '',
    phone: '',
    insurance: '',
  })
}

// 移除员工
function removeEmployee(index: number) {
  if (form.value.ylfkCheckApplicationPage.checkUsersList.length > 1) {
    uni.showModal({
      title: '提示',
      content: '确定要删除该员工信息吗？',
      success: (res) => {
        if (res.confirm) {
          form.value.ylfkCheckApplicationPage.checkUsersList.splice(index, 1)
          const newUploaders = {}
          Object.keys(employeeUploaders.value).forEach((key) => {
            const keyNum = Number.parseInt(key)
            if (keyNum < index) {
              newUploaders[keyNum] = employeeUploaders.value[keyNum]
            }
            else if (keyNum > index) {
              newUploaders[keyNum - 1] = employeeUploaders.value[keyNum]
            }
          })
          employeeUploaders.value = newUploaders
        }
      },
    })
  }
  else {
    uni.showToast({
      title: '至少保留一项员工信息',
      icon: 'none',
    })
  }
}

function getEmployeeUploader(index) {
  if (!employeeUploaders.value[index]) {
    const { loading, error, data, progress, run } = useUpload(
      uploadFileUrl.USER_AVATAR,
      {},
      {
        maxSize: 5,
        onSuccess: (res) => {
          console.log(`员工${index}保险图片上传成功:`, res)
          form.value.ylfkCheckApplicationPage.checkUsersList[index].insurance
            = res.message
        },
        onError: (err) => {
          console.error(`员工${index}保险图片上传失败:`, err)
          uni.showToast({
            title: '保险图片上传失败',
            icon: 'none',
          })
        },
      },
    )

    employeeUploaders.value[index] = { loading, error, data, progress, run }
  }

  return employeeUploaders.value[index]
}

function isNotLoading(index) {
  try {
    return !getEmployeeUploader(index).loading.value
  }
  catch {
    return true
  }
}

// 上传保险
function uploadInsurance(index: number) {
  const uploader = getEmployeeUploader(index)
  if (uploader.loading.value)
    return
  uploader.run()
}
// 预览保险图片
function previewInsurance(index) {
  const employee = form.value.ylfkCheckApplicationPage.checkUsersList[index]
  if (!employee.insurance)
    return

  const imageUrl = `${baseUrl}/${employee.insurance}`

  uni.previewImage({
    current: imageUrl,
    urls: [imageUrl],
    longPressActions: {
      itemList: ['保存图片'],
      success: (res) => {
        if (res.tapIndex === 0) {
          uni.saveImageToPhotosAlbum({
            filePath: imageUrl,
            success: () => {
              uni.showToast({
                title: '保存成功',
                icon: 'success',
              })
            },
            fail: (err) => {
              console.error('保存失败:', err)
              uni.showToast({
                title: '保存失败',
                icon: 'none',
              })
            },
          })
        }
      },
    },
  })
}

// 删除保险图片
function deleteInsurance(index) {
  form.value.ylfkCheckApplicationPage.checkUsersList[index].insurance = ''
}

const applyId = ref('')
const showReject = ref<boolean>(false)
const showTransfer = ref<boolean>(false)
const showApproval = ref<boolean>(false)
const rejectReason = ref<string>('')
const currentNode = ref('')
const value = ref<number[]>([])
const isView = ref(false)
const disable = ref(false)
// 新增变量来跟踪审批状态和来源
const isFromApproved = ref(false) // 是否来自已审批页面
const approvalHistory = ref([]) // 审批历史记录
function closePopup(data) {
  console.log(data)
  showReject.value = data
}

function closeTransferPopup(data) {
  showTransfer.value = data
}
function closeApprovalPopup() {
  showApproval.value = false
}
const columns = ref([
  '选项1',
  '选项2',
  '选项3',
  '选项4',
  '选项5',
  '选项6',
  '选项7',
])
const isShow = ref(false)
const value1 = ref('选项1')
function handleConfirm1({ value }) {
  value1.value = value
}
async function submit() {
  console.log(form.value)
  const res = await submitApplication(form.value)
  if (res.code === 200) {
    uni.showToast({
      title: '提交成功',
      icon: 'success',
      duration: 2000,
    })
    setTimeout(() => {
      uni.switchTab({ url: '/pages/index/index' })
    }, 2000)
  }
}
function onReject() {
  showReject.value = true
}

function onTransfer() {
  showTransfer.value = true
}

function onApprove() {
  showApproval.value = true
}

async function getDepartList() {
  const res = await getAllDepartment()
  if (res.result) {
    departments.value = res.result.map(item => ({
      label: item.departName,
      value: item.id,
    }))
  }
}
async function Approval(form) {
  const res = await toApprovalApplication(form)
  if (res.code === 200) {
    uni.switchTab({
      url: '/pages/audit/audit',
    })
  }
}

async function confirmApproval() {
  form1.user = currentLoginedUser
  form1.applicationCode = applyId.value
  if (approvals.value.manager === true) {
    form1.userOpinion = '我已确认信息无误'
  }
  else if (approvals.value.admin === true) {
    form1.userOpinion = '我已办理预住手续'
  }
  else if (approvals.value.hr === true) {
    form1.userOpinion = '我已确认商保信息无误'
  }
  else if (approvals.value.guardEnter === true) {
    form1.userOpinion = '我已确认入厂车辆物资信息完整'
  }
  // else if (approvals.value.guard === true) {
  //   form1.userOpinion = '已阅'
  // }
  form1.copyUser = value1.value
  form1.applicationResult = '0'
  await Approval(form1)
}

// 人员类型监听器
watch(
  () => form.value?.ylfkCheckApplicationPage?.userType,
  (newValue) => {
    if (newValue && employeeTypes.value.length > 0) {
      const matchedType = employeeTypes.value.find(
        type => type.value === newValue,
      )
      if (matchedType) {
        employeeType.value = matchedType
      }
    }
  },
  { immediate: true },
)

// 所属部门监听器
watch(
  () => form.value?.ylfkCheckApplicationPage?.belongDept,
  (newValue) => {
    if (newValue && departments.value.length > 0) {
      const matchedDepartment = departments.value.find(
        dept => dept.value === newValue,
      )
      if (matchedDepartment) {
        department.value = matchedDepartment
      }
    }
  },
  { immediate: true },
)

// 初始化选择器状态
function initializeSelections() {
  // 初始化人员类型
  if (form.value?.ylfkCheckApplicationPage?.userType) {
    const matchedType = employeeTypes.value.find(
      type => type.value === form.value.ylfkCheckApplicationPage.userType,
    )
    if (matchedType) {
      employeeType.value = matchedType
    }
  }

  // 初始化部门
  if (form.value?.ylfkCheckApplicationPage?.belongDept) {
    const matchedDepartment = departments.value.find(
      dept => dept.value === form.value.ylfkCheckApplicationPage.belongDept,
    )
    if (matchedDepartment) {
      department.value = matchedDepartment
    }
  }
}

onLoad(async (e) => {
  console.log(e, '参数')
  currentNode.value = e.currentNode

  // 判断是否来自已审批页面
  isFromApproved.value = e.view === 'true'

  await getDepartList()
  if (e.applyId) {
    applyId.value = e.applyId
    const res = await getYlfkApplicationDetail(e.applyId, e.applicationType)
    if (res.code === 200) {
      form.value = res.result

      // 如果来自已审批页面，获取审批历史
      if (
        isFromApproved.value
        && res.result
        && typeof res.result === 'object'
        && 'approvalHistory' in res.result
      ) {
        approvalHistory.value = (res.result as any).approvalHistory || []
      }

      initializeSelections()
    }

    // 只有访客角色才禁用表单
    if (e.roleType === '访客') {
      disable.value = true
      isShow.value = false
    }
    else if (e.roleType === '部门审核') {
      // 部门审核时，基础信息始终禁用，只允许审批操作
      if (e.view === 'true') {
        disable.value = true
        isShow.value = false
        isView.value = true
      }
      else {
        disable.value = true // 基础信息禁用
        isShow.value = true // 显示审批按钮
      }
    }
    else if (e.roleType === '门卫') {
      disable.value = true
      isShow.value = true
    }
    else {
      // 其他角色默认不禁用，允许审批操作
      disable.value = false
      isShow.value = true
    }
  }
  else {
    // 新建申请时不禁用
    disable.value = false
  }
})

const uploadedExcelFile = ref(null)

// Excel上传器
const excelUploader = ref(null)
// 车辆照片上传器
const carImageUploader = ref(null)
// 物资照片上传器
const goodsImageUploader = ref(null)

function getExcelUploader() {
  if (!excelUploader.value) {
    const { loading, error, data, progress, run } = useUpload(
      uploadFileUrl.USER_AVATAR, // 使用现有的上传接口
      {},
      {
        maxSize: 10, // Excel文件最大10MB
        onSuccess: (res) => {
          console.log('Excel文件上传成功:', res)
          uploadedExcelFile.value = {
            name: res.originalName || '工具/物资信息表.xlsx',
            url: res.message,
            size: res.size,
          }
          // 将文件信息保存到表单数据中
          form.value.ylfkCheckApplicationPage.goodsInfo = res.message
          uni.showToast({
            title: 'Excel文件上传成功',
            icon: 'success',
          })
        },
        onError: (err) => {
          console.error('Excel文件上传失败:', err)
          uni.showToast({
            title: 'Excel文件上传失败',
            icon: 'none',
          })
        },
      },
    )

    excelUploader.value = { loading, error, data, progress, run }
  }

  return excelUploader.value
}

function getCarImageUploader() {
  if (!carImageUploader.value) {
    const { loading, error, data, progress, run } = useUpload(
      uploadFileUrl.USER_AVATAR,
      {},
      {
        maxSize: 5,
        onSuccess: (res) => {
          console.log('车辆照片上传成功:', res)
          form1.carImage = res.message
          uni.showToast({
            title: '车辆照片上传成功',
            icon: 'success',
          })
        },
        onError: (err) => {
          console.error('车辆照片上传失败:', err)
          uni.showToast({
            title: '车辆照片上传失败',
            icon: 'none',
          })
        },
      },
    )

    carImageUploader.value = { loading, error, data, progress, run }
  }

  return carImageUploader.value
}

function uploadCarImage() {
  const uploader = getCarImageUploader()
  if (uploader.loading.value) {
    uni.showToast({
      title: '正在上传中，请稍候',
      icon: 'none',
    })
    return
  }
  uploader.run()
}

function previewCarImage() {
  if (!form1.carImage)
    return

  const imageUrl = `${baseUrl}/${form1.carImage}`

  uni.previewImage({
    current: imageUrl,
    urls: [imageUrl],
    longPressActions: {
      itemList: ['保存图片'],
      success: (res) => {
        if (res.tapIndex === 0) {
          uni.saveImageToPhotosAlbum({
            filePath: imageUrl,
            success: () => {
              uni.showToast({
                title: '保存成功',
                icon: 'success',
              })
            },
            fail: (err) => {
              console.error('保存失败:', err)
              uni.showToast({
                title: '保存失败',
                icon: 'none',
              })
            },
          })
        }
      },
    },
  })
}

function deleteCarImage() {
  form1.carImage = ''
}

function getGoodsImageUploader() {
  if (!goodsImageUploader.value) {
    const { loading, error, data, progress, run } = useUpload(
      uploadFileUrl.USER_AVATAR,
      {},
      {
        maxSize: 5,
        onSuccess: (res) => {
          console.log('物资照片上传成功:', res)
          form1.goodsImage = res.message
          uni.showToast({
            title: '物资照片上传成功',
            icon: 'success',
          })
        },
        onError: (err) => {
          console.error('物资照片上传失败:', err)
          uni.showToast({
            title: '物资照片上传失败',
            icon: 'none',
          })
        },
      },
    )

    goodsImageUploader.value = { loading, error, data, progress, run }
  }

  return goodsImageUploader.value
}

function uploadGoodsImage() {
  const uploader = getGoodsImageUploader()
  if (uploader.loading.value) {
    uni.showToast({
      title: '正在上传中，请稍候',
      icon: 'none',
    })
    return
  }
  uploader.run()
}

function previewGoodsImage() {
  if (!form1.goodsImage)
    return

  const imageUrl = `${baseUrl}/${form1.goodsImage}`

  uni.previewImage({
    current: imageUrl,
    urls: [imageUrl],
    longPressActions: {
      itemList: ['保存图片'],
      success: (res) => {
        if (res.tapIndex === 0) {
          uni.saveImageToPhotosAlbum({
            filePath: imageUrl,
            success: () => {
              uni.showToast({
                title: '保存成功',
                icon: 'success',
              })
            },
            fail: (err) => {
              console.error('保存失败:', err)
              uni.showToast({
                title: '保存失败',
                icon: 'none',
              })
            },
          })
        }
      },
    },
  })
}

function deleteGoodsImage() {
  form1.goodsImage = ''
}

function selectExcelFile() {
  const uploader = getExcelUploader()
  if (uploader.loading.value) {
    uni.showToast({
      title: '正在上传中，请稍候',
      icon: 'none',
    })
    return
  }
  uploader.run()
}

function downloadExcelFile() {
  if (!uploadedExcelFile.value?.url) {
    uni.showToast({
      title: '没有可下载的文件',
      icon: 'none',
    })
    return
  }

  const fileUrl = `${baseUrl}/${uploadedExcelFile.value.url}`

  // 使用uni.downloadFile下载文件
  uni.downloadFile({
    url: fileUrl,
    header: { 'X-Access-Token': userStore.userInfo.token },
    success: (res) => {
      if (res.statusCode === 200) {
        uni.showToast({
          title: '下载成功',
          icon: 'success',
        })
        // 可以选择保存到相册或打开文件
        uni.openDocument({
          filePath: res.tempFilePath,
          success: () => {
            console.log('打开文档成功')
          },
          fail: (err) => {
            console.error('打开文档失败:', err)
          },
        })
      }
    },
    fail: (err) => {
      console.error('下载失败:', err)
      uni.showToast({
        title: '下载失败',
        icon: 'none',
      })
    },
  })
}

function removeExcelFile() {
  uploadedExcelFile.value = null
  form.value.ylfkCheckApplicationPage.goodsInfo = ''
  uni.showToast({
    title: '文件已删除',
    icon: 'success',
  })
}

// 添加计算属性来确保部门名称正确显示
const displayDepartmentName = computed(() => {
  // 如果 department 有值，优先使用
  if (department.value?.label) {
    return department.value.label
  }

  // 如果没有，尝试从部门列表中实时查找
  if (
    form.value?.ylfkCheckApplicationPage?.belongDept
    && departments.value.length > 0
  ) {
    const dept = departments.value.find(
      d => d.value === form.value.ylfkCheckApplicationPage.belongDept,
    )
    if (dept) {
      return dept.label
    }
    return '未知部门'
  }

  return '请选择所属部门'
})

const isExcelUploading = computed(() => {
  return getExcelUploader().loading.value
})

// 计算属性：判断复选框是否应该被禁用
const shouldDisableCheckbox = computed(() => (nodeName) => {
  // 基本禁用条件：访客角色或查看模式
  const basicDisabled = disable.value

  // 节点已审批条件
  const nodeApproved = isNodeApproved(nodeName)

  // 当前不是该节点的审批者（只在待审批页面时检查）
  const notCurrentApprover
    = !isFromApproved.value && currentNode.value !== nodeName

  console.log('复选框禁用状态计算:', {
    nodeName,
    basicDisabled,
    nodeApproved,
    notCurrentApprover,
    currentNode: currentNode.value,
    isFromApproved: isFromApproved.value,
    result: basicDisabled || nodeApproved || notCurrentApprover,
  })

  return basicDisabled || nodeApproved || notCurrentApprover
})

// 判断当前用户是否可以对某个节点进行审批
const canApproveNode = computed(() => (nodeName) => {
  // 如果是访客身份，完全不能审批
  const isVisitor = disable.value && !isShow.value
  if (isVisitor) {
    return false
  }

  // 如果是查看模式，不能审批
  if (isFromApproved.value) {
    return false
  }

  // 如果没有申请ID，不能审批
  if (currentNode.value === '' || !applyId.value) {
    return false
  }

  // 如果节点已审批，不能再次审批
  if (isNodeApproved(nodeName)) {
    return false
  }

  // 只有当前节点的审批者可以审批
  return currentNode.value === nodeName
})

// 判断是否应该显示某个审批节点
function shouldShowApprovalNode(nodeNames) {
  console.log('shouldShowApprovalNode called:', {
    nodeNames,
    applyId: applyId.value,
    isVisitor: disable.value && !isShow.value,
    currentNode: currentNode.value,
    isFromApproved: isFromApproved.value,
  })

  if (!applyId.value)
    return false

  // 如果是访客身份，只显示当前节点及之前已完成的审批节点
  const isVisitor = disable.value && !isShow.value

  // 定义审批流程顺序
  const approvalFlow = [
    '归口管理部门经理室审核',
    '人资部行政部审核',
    '门卫入厂审批',
    '门卫离厂审批',
  ]

  // 如果来自待审批页面且不是访客，只显示当前节点
  if (!isFromApproved.value && !isVisitor) {
    return nodeNames.includes(currentNode.value)
  }

  // 访客逻辑：根据当前状态显示审批信息
  if (isVisitor) {
    // 特殊处理：如果没有当前审批节点（可能是已入厂状态）或者是发起离厂申请状态，显示所有已完成的审批节点
    if (!currentNode.value || currentNode.value === '' || currentNode.value === '发起离厂申请') {
      console.log('访客查看已入厂状态，显示所有已完成的审批节点')
      console.log('审批流程:', approvalFlow)

      // 对于已入厂状态，应该显示所有到门卫入厂审批为止的节点
      for (const nodeName of nodeNames) {
        const nodeIndex = approvalFlow.indexOf(nodeName)
        const guardEnterIndex = approvalFlow.indexOf('门卫入厂审批')
        const isMatch = nodeIndex !== -1 && nodeIndex <= guardEnterIndex
        console.log(`检查节点 ${nodeName}: nodeIndex=${nodeIndex}, guardEnterIndex=${guardEnterIndex}, 匹配=${isMatch}`)

        if (isMatch) {
          console.log(`shouldShowApprovalNode 返回 true，因为找到匹配节点: ${nodeName}`)
          return true
        }
      }

      console.log('shouldShowApprovalNode 返回 false，没有找到匹配的节点')
      return false
    }

    const currentNodeIndex = approvalFlow.indexOf(currentNode.value)

    // 如果当前节点不在流程中，不显示任何节点
    if (currentNodeIndex === -1) {
      return false
    }

    // 只显示当前节点及之前的节点
    return nodeNames.some((nodeName) => {
      const nodeIndex = approvalFlow.indexOf(nodeName)
      return nodeIndex !== -1 && nodeIndex <= currentNodeIndex
    })
  }

  // 如果来自已审批页面，需要显示按流程顺序到当前节点为止的所有节点
  const currentNodeIndex = approvalFlow.indexOf(currentNode.value)

  // 如果当前节点不在流程中，按原逻辑处理
  if (currentNodeIndex === -1) {
    const hasCurrentNode = nodeNames.includes(currentNode.value)
    const hasHistoryNode = nodeNames.some(nodeName =>
      approvalHistory.value.some(history => history.nodeName === nodeName),
    )
    return hasCurrentNode || hasHistoryNode
  }

  // 检查节点数组中是否包含应该显示的节点
  // 应该显示当前节点以及之前的所有节点
  return nodeNames.some((nodeName) => {
    const nodeIndex = approvalFlow.indexOf(nodeName)
    return nodeIndex !== -1 && nodeIndex <= currentNodeIndex
  })
}

// 判断某个节点是否已经审批过
function isNodeApproved(nodeName) {
  console.log('检查节点审批状态:', {
    nodeName,
    approvalHistory: approvalHistory.value,
    isFromApproved: isFromApproved.value,
    currentNode: currentNode.value,
  })

  // 访客查看时的逻辑
  const isVisitor = disable.value && !isShow.value
  if (isVisitor) {
    const approvalFlow = [
      '归口管理部门经理室审核',
      '人资部行政部审核',
      '门卫入厂审批',
      '门卫离厂审批',
    ]

    // 特殊处理：如果没有当前审批节点（已入厂状态）或者是发起离厂申请状态，所有到门卫入厂审批的节点都已审批
    if (!currentNode.value || currentNode.value === '' || currentNode.value === '发起离厂申请') {
      const nodeIndex = approvalFlow.indexOf(nodeName)
      const guardEnterIndex = approvalFlow.indexOf('门卫入厂审批')
      // 所有到门卫入厂审批（包含）的节点都显示为已审批
      return nodeIndex !== -1 && nodeIndex <= guardEnterIndex
    }

    const nodeIndex = approvalFlow.indexOf(nodeName)
    const currentIndex = approvalFlow.indexOf(currentNode.value)

    // 如果是当前节点之前的节点，认为已审批
    if (nodeIndex !== -1 && currentIndex !== -1 && nodeIndex < currentIndex) {
      return true
    }

    // 当前节点不显示为已审批（正在审批中）
    return false
  }

  // 如果不是来自已审批页面，默认认为节点未审批
  if (!isFromApproved.value) {
    return false
  }

  // 检查审批历史中是否存在该节点的已审批记录
  const isApproved = approvalHistory.value.some(
    history => history.nodeName === nodeName && history.status === 'approved',
  )

  console.log(`节点 ${nodeName} 审批状态:`, isApproved)
  return isApproved
}
</script>

<template>
  <view class="container">
    <scroll-view
      class="content"
      :class="{ 'has-submit-btn': !applyId || (applyId && isShow) }"
      scroll-y
    >
      <form>
        <!-- 申请单号 -->
        <view v-if="applyId" class="form-section">
          <view class="application-number-row">
            <text class="form-label">申请单号：</text>
            <text class="form-value">{{ applyId }}</text>
          </view>
        </view>

        <!-- 基础信息 -->
        <view class="form-section">
          <text class="section-title">基础信息</text>

          <!-- 人员类型 -->
          <view class="form-row">
            <text class="form-label">
              人员类型 <text class="required">*</text>
            </text>
            <picker
              mode="selector"
              :range="employeeTypes"
              range-key="label"
              :disabled="disable"
              @change="onEmployeeTypeChange"
            >
              <view class="picker">
                {{ employeeType.label || "请选择人员类型" }}
                <view class="i-carbon-chevron-down text-16px text-gray-400" />
              </view>
            </picker>
          </view>

          <!-- 两列布局的信息 -->
          <view class="form-grid">
            <!-- 单位名称 -->
            <view class="form-row">
              <text class="form-label">
                单位名称 <text class="required">*</text>
              </text>
              <input
                v-model="form.ylfkCheckApplicationPage.deptName"
                type="text"
                :disabled="disable"
                placeholder="请输入单位名称"
                class="form-input"
              >
            </view>

            <!-- 申请人姓名 -->
            <view class="form-row">
              <text class="form-label">
                申请人姓名 <text class="required">*</text>
              </text>
              <input
                v-model="form.ylfkCheckApplicationPage.user"
                type="text"
                :disabled="disable"
                placeholder="请输入申请人姓名"
                class="form-input"
              >
            </view>
          </view>

          <view class="form-grid">
            <!-- 身份证号 -->
            <view class="form-row">
              <text class="form-label">
                身份证号 <text class="required">*</text>
              </text>
              <input
                v-model="form.ylfkCheckApplicationPage.idCard"
                type="text"
                :disabled="disable"
                placeholder="请输入身份证号"
                class="form-input"
              >
            </view>

            <!-- 联系电话 -->
            <view class="form-row">
              <text class="form-label">
                联系电话 <text class="required">*</text>
              </text>
              <input
                v-model="form.ylfkCheckApplicationPage.phone"
                :disabled="disable"
                type="tel"
                placeholder="请输入联系电话"
                class="form-input"
              >
            </view>
          </view>

          <!-- 所属部门 -->
          <view class="form-row">
            <text class="form-label">
              所属部门 <text class="required">*</text>
            </text>
            <picker
              mode="selector"
              :range="departments"
              range-key="label"
              :disabled="disable"
              @change="onDepartmentChange"
            >
              <view class="picker">
                {{ displayDepartmentName }}
                <view class="i-carbon-chevron-down text-16px text-gray-400" />
              </view>
            </picker>
          </view>

          <!-- 总人数 -->
          <view class="form-row">
            <text class="form-label">
              总人数 <text class="required">*</text>
            </text>
            <input
              v-model="form.ylfkCheckApplicationPage.allUsers"
              type="number"
              placeholder="请输入总人数"
              :disabled="disable"
              min="1"
              class="form-input"
            >
          </view>
        </view>
        <!-- 员工清单 -->
        <view class="form-section">
          <view class="section-header">
            <text class="section-title">
              员工清单 <text class="required">*</text>
            </text>
            <view class="import-btn" @click="importExcel">
              <view class="i-carbon-upload text-16px text-blue-500" />
              <text>导入Excel</text>
            </view>
          </view>

          <view v-if="uploadedFileName" class="uploaded-file">
            <view class="file-info">
              <view class="i-carbon-document text-20px text-green-500" />
              <text class="file-name">{{ uploadedFileName }}</text>
            </view>
            <view class="download-btn" @click="downloadFile">
              <view class="i-carbon-download text-16px text-blue-500" />
              <text>下载</text>
            </view>
          </view>

          <view class="employee-list">
            <view
              v-for="(employee, index) in form.ylfkCheckApplicationPage
                .checkUsersList"
              :key="index"
              class="employee-card"
            >
              <view
                class="i-carbon-close delete-employee text-20px text-gray-400"
                @click="removeEmployee(index)"
              />

              <view class="form-row">
                <text class="form-label">姓名</text>
                <input
                  v-model="employee.name"
                  type="text"
                  :disabled="disable"
                  placeholder="请输入员工姓名"
                  class="form-input"
                >
              </view>

              <view class="form-row">
                <text class="form-label">身份证号</text>
                <input
                  v-model="employee.cardCode"
                  type="text"
                  :disabled="disable"
                  placeholder="请输入身份证号"
                  class="form-input"
                >
              </view>

              <view class="form-row">
                <text class="form-label">联系电话</text>
                <input
                  v-model="employee.phone"
                  :disabled="disable"
                  type="tel"
                  placeholder="请输入联系电话"
                  class="form-input"
                >
              </view>

              <view class="form-row">
                <text class="form-label">商业保险</text>

                <!-- 如果没有上传图片，显示上传区域 -->
                <view
                  v-if="!employee.insurance"
                  class="upload-area"
                  :class="{
                    uploading: getEmployeeUploader(index).loading.value,
                  }"
                  @click="uploadInsurance(index)"
                >
                  <view
                    v-if="isNotLoading(index)"
                    class="i-carbon-cloud-upload text-24px text-gray-400"
                  />
                  <view v-else class="loading-spinner">
                    <view
                      class="i-carbon-loading rotating text-24px text-gray-400"
                    />
                  </view>
                  <text class="upload-text">
                    {{
                      getEmployeeUploader(index).loading.value
                        ? "上传中..."
                        : "点击上传商业保险图片"
                    }}
                  </text>
                </view>

                <!-- 如果已上传，显示图片预览 -->
                <view v-else class="insurance-preview">
                  <image
                    :src="`${baseUrl}/${employee.insurance}`"
                    mode="aspectFit"
                    class="insurance-image"
                    @click="previewInsurance(index)"
                  />
                  <view class="image-close-btn" @click.stop="deleteInsurance(index)">
                    <view class="i-carbon-close text-14px" />
                  </view>
                  <view class="preview-tip">
                    点击预览
                  </view>
                </view>

                <!-- 上传失败提示 -->
                <view v-if="!isNotLoading(index)" class="error-tip">
                  <text>上传失败，请重试</text>
                </view>
              </view>
            </view>
          </view>

          <view v-if="!disable" class="add-employee-btn" @click="addEmployee">
            <view class="i-carbon-add text-16px text-white" />
            <text>添加员工</text>
          </view>
        </view>

        <!-- 车辆信息 -->
        <view class="form-section">
          <view class="section-header">
            <text class="section-title">
              车辆信息 <text class="required">*</text>
            </text>
          </view>

          <view class="vehicle-info">
            <input
              v-model="form.ylfkCheckApplicationPage.carCode"
              type="text"
              placeholder="请输入车牌号"
              class="form-input flex-1"
              :disabled="disable"
            >
          </view>
        </view>

        <!-- 工具物资 -->
        <view class="form-section">
          <view class="section-header">
            <text class="section-title">
              工具/物资信息 <text class="required">*</text>
            </text>
          </view>
          <view class="excel-upload-container">
            <!-- 上传进度显示 -->
            <view v-if="isExcelUploading" class="excel-upload-progress">
              <view class="progress-content">
                <view
                  class="i-carbon-loading rotating text-24px text-blue-500"
                />
                <text class="progress-text">正在上传Excel文件...</text>
              </view>
            </view>

            <!-- 未上传状态 -->
            <view
              v-else-if="!uploadedExcelFile"
              class="excel-upload-area"
              @click="selectExcelFile"
            >
              <text class="upload-icon">📊</text>
              <text class="upload-text">导入工具/物资信息列表</text>
            </view>

            <!-- 已上传状态 -->
            <view v-else class="excel-file-display">
              <view class="file-info">
                <text class="file-icon">📄</text>
                <text class="file-name">{{ uploadedExcelFile.name }}</text>
              </view>
              <view class="file-actions">
                <text class="download-btn" @click="downloadExcelFile">
                  下载
                </text>
                <text class="delete-btn" @click="removeExcelFile">删除</text>
              </view>
            </view>
          </view>
        </view>

        <!-- 审核信息 -->
        <view v-if="applyId" class="form-section">
          <text class="section-title">审核信息</text>

          <!-- 部门经理审核 -->
          <view
            v-if="
              shouldShowApprovalNode([
                '归口管理部门经理室审核',
              ])
            "
            class="approval-card"
            :class="{
              'approved-node': isNodeApproved('归口管理部门经理室审核'),
            }"
          >
            <text class="approval-title">
              归口管理部门经理室审核
              <text
                v-if="isNodeApproved('归口管理部门经理室审核')"
                class="approval-status"
              >
                （已审批）
              </text>
            </text>
            <label class="approval-checkbox">
              <wd-checkbox
                v-model="approvals.manager"
                :disabled="!canApproveNode('归口管理部门经理室审核')"
              >
                我已确认信息无误
              </wd-checkbox>
            </label>
          </view>

          <!-- 人资部审核 -->
          <view
            v-if="
              shouldShowApprovalNode(['人资部行政部审核'])
                && (isView || currentNode !== '人资部行政部审核' || currentDepartment === '人资部')
            "
            class="approval-card"
            :class="{ 'approved-node': isNodeApproved('人资部行政部审核') }"
          >
            <text class="approval-title">
              人资部审核
              <text
                v-if="isNodeApproved('人资部行政部审核')"
                class="approval-status"
              >
                （已审批）
              </text>
            </text>
            <label class="approval-checkbox">
              <wd-checkbox
                v-model="approvals.hr"
                :disabled="!canApproveNode('人资部行政部审核')"
              >
                我已确认商保信息无误
              </wd-checkbox>
            </label>
          </view>

          <!-- 行政部审核 -->
          <view
            v-if="
              shouldShowApprovalNode(['人资部行政部审核'])
                && (isView || currentNode !== '人资部行政部审核' || currentDepartment === '行政部')
            "
            class="approval-card"
            :class="{ 'approved-node': isNodeApproved('人资部行政部审核') }"
          >
            <text class="approval-title">
              行政部审核
              <text
                v-if="isNodeApproved('人资部行政部审核')"
                class="approval-status"
              >
                （已审批）
              </text>
            </text>
            <label class="approval-checkbox">
              <wd-checkbox
                v-model="approvals.admin"
                :disabled="!canApproveNode('人资部行政部审核')"
              >
                我已办理预住手续
              </wd-checkbox>
            </label>
          </view>

          <!-- 门卫入厂审核 -->
          <view
            v-if="shouldShowApprovalNode(['门卫入厂审批'])"
            class="approval-card"
            :class="{ 'approved-node': isNodeApproved('门卫入厂审批') }"
          >
            <text class="approval-title">
              门卫入厂审核
              <text
                v-if="isNodeApproved('门卫入厂审批')"
                class="approval-status"
              >
                （已审批）
              </text>
            </text>

            <!-- 车辆信息 -->
            <view class="guard-section">
              <text class="section-label">车辆信息</text>

              <view class="info-row">
                <text v-if="form.ylfkCheckApplicationPage.carCode" class="info-label">
                  车牌号：{{ form.ylfkCheckApplicationPage.carCode }}
                </text>
                <view v-else>
                  <text class="info-label">
                    车牌号：
                  </text>
                  <text class="info-value">无</text>
                </view>
              </view>

              <view class="info-row">
                <text class="info-label">临时通行证号</text>
                <input
                  v-model="form1.carNumber"
                  type="text"
                  placeholder="请输入临时通行证号"
                  class="guard-input"
                  :disabled="disable"
                >
              </view>

              <!-- 车辆照片上传 -->
              <view class="upload-section">
                <text class="upload-label">车辆照片</text>

                <!-- 如果没有上传图片，显示上传区域 -->
                <view
                  v-if="!form1.carImage"
                  class="guard-upload-area"
                  :class="{
                    uploading: getCarImageUploader().loading.value,
                    disabled: disable,
                  }"
                  @click="!disable && uploadCarImage"
                >
                  <view
                    v-if="!getCarImageUploader().loading.value"
                    class="upload-icon"
                  >
                    📷
                  </view>
                  <view v-else class="loading-spinner">
                    <view class="i-carbon-loading rotating text-24px text-gray-400" />
                  </view>
                  <text class="upload-text">
                    {{
                      disable ? "无权限上传"
                      : getCarImageUploader().loading.value ? "上传中..."
                        : "上传车辆照片"
                    }}
                  </text>
                </view>

                <!-- 如果已上传，显示图片预览 -->
                <view v-else class="image-preview-container">
                  <image
                    :src="`${baseUrl}/${form1.carImage}`"
                    mode="aspectFit"
                    class="preview-image"
                    @click="previewCarImage"
                  />
                  <view
                    v-if="!disable"
                    class="image-close-btn"
                    @click.stop="deleteCarImage"
                  >
                    <view class="i-carbon-close text-14px" />
                  </view>
                  <view class="preview-tip">
                    点击预览
                  </view>
                </view>
              </view>
            </view>

            <!-- 工具/物资信息 -->
            <view class="guard-section">
              <text class="section-label">工具/物资信息</text>

              <view class="info-row">
                <text class="info-label">工具/物资清单：</text>
              </view>

              <!-- Excel文件信息显示 -->
              <view v-if="uploadedExcelFile" class="excel-file-info" @click="downloadExcelFile">
                <view class="file-display">
                  <text class="file-icon">📄</text>
                  <text class="file-name">{{ uploadedExcelFile.name }}</text>
                </view>
                <view class="download-indicator">
                  <text class="download-text">点击下载</text>
                  <view class="i-carbon-download text-16px text-blue-500" />
                </view>
              </view>

              <!-- 无文件时的占位显示 -->
              <view v-else class="no-file-placeholder">
                <text class="placeholder-text">暂无工具/物资清单文件</text>
              </view>

              <!-- 物资照片上传 -->
              <view class="upload-section">
                <text class="upload-label">物资照片</text>

                <!-- 如果没有上传图片，显示上传区域 -->
                <view
                  v-if="!form1.goodsImage"
                  class="guard-upload-area"
                  :class="{
                    uploading: getGoodsImageUploader().loading.value,
                    disabled: disable,
                  }"
                  @click="!disable && uploadGoodsImage"
                >
                  <view
                    v-if="!getGoodsImageUploader().loading.value"
                    class="upload-icon"
                  >
                    📷
                  </view>
                  <view v-else class="loading-spinner">
                    <view class="i-carbon-loading rotating text-24px text-gray-400" />
                  </view>
                  <text class="upload-text">
                    {{
                      disable ? "无权限上传"
                      : getGoodsImageUploader().loading.value ? "上传中..."
                        : "上传物资照片"
                    }}
                  </text>
                </view>

                <!-- 如果已上传，显示图片预览 -->
                <view v-else class="image-preview-container">
                  <image
                    :src="`${baseUrl}/${form1.goodsImage}`"
                    mode="aspectFit"
                    class="preview-image"
                    @click="previewGoodsImage"
                  />
                  <view
                    v-if="!disable"
                    class="image-close-btn"
                    @click.stop="deleteGoodsImage"
                  >
                    <view class="i-carbon-close text-14px" />
                  </view>
                  <view class="preview-tip">
                    点击预览
                  </view>
                </view>
              </view>
            </view>

            <!-- 确认复选框 -->
            <view class="guard-checkbox">
              <wd-checkbox
                v-model="approvals.guardEnter"
                :disabled="!canApproveNode('门卫入厂审批')"
              >
                我已确认入厂车辆物资信息完整
              </wd-checkbox>
            </view>
          </view>

          <!-- 门卫离厂审核 -->
          <view
            v-if="shouldShowApprovalNode(['门卫离厂审批'])"
            class="approval-card"
            :class="{ 'approved-node': isNodeApproved('门卫离厂审批') }"
          >
            <text class="approval-title">
              门卫离厂审核
              <text
                v-if="isNodeApproved('门卫离厂审批')"
                class="approval-status"
              >
                （已审批）
              </text>
            </text>

            <!-- 车辆信息 -->
            <view class="guard-section">
              <text class="section-label">车辆信息</text>

              <view class="info-row">
                <text class="info-label">车牌号：</text>
                <text class="info-value">-</text>
              </view>

              <view class="info-row">
                <text class="info-label">临时通行证号：</text>
                <text class="info-value">-</text>
              </view>

              <!-- 归还通行证复选框 -->
              <view class="guard-checkbox">
                <wd-checkbox
                  v-model="approvals.guardReturnPass"
                  :disabled="!canApproveNode('门卫离厂审批')"
                >
                  已归还临时通行证
                </wd-checkbox>
              </view>

              <!-- 离厂车辆照片上传 -->
              <view class="upload-section">
                <text class="upload-label">离厂车辆照片</text>
                <view class="guard-upload-area">
                  <text class="upload-icon">📷</text>
                  <text class="upload-text">上传离厂车辆照片</text>
                </view>
              </view>
            </view>

            <!-- 工具/物资信息 -->
            <view class="guard-section">
              <text class="section-label">工具/物资信息</text>

              <view class="info-row">
                <text class="info-label">物资清单：</text>
              </view>

              <!-- Excel文件信息显示 -->
              <view v-if="uploadedExcelFile" class="excel-file-info" @click="downloadExcelFile">
                <view class="file-display">
                  <text class="file-icon">📄</text>
                  <text class="file-name">{{ uploadedExcelFile.name }}</text>
                </view>
                <view class="download-indicator">
                  <text class="download-text">点击下载</text>
                  <view class="i-carbon-download text-16px text-blue-500" />
                </view>
              </view>

              <!-- 无文件时的占位显示 -->
              <view v-else class="no-file-placeholder">
                <text class="placeholder-text">暂无物资清单文件</text>
              </view>

              <!-- 离厂物资照片上传 -->
              <view class="upload-section">
                <text class="upload-label">离厂物资照片</text>
                <view class="guard-upload-area">
                  <text class="upload-icon">📷</text>
                  <text class="upload-text">上传离厂物资照片</text>
                </view>
              </view>
            </view>

            <!-- 确认复选框 -->
            <view class="guard-checkbox">
              <wd-checkbox
                v-model="approvals.guardExit"
                :disabled="!canApproveNode('门卫离厂审批')"
              >
                我已确认离厂信息完整
              </wd-checkbox>
            </view>
          </view>
        </view>
      </form>
    </scroll-view>

    <!-- 底部按钮 -->
    <FooterBtn
      v-if="applyId && isShow"
      @reject="onReject"
      @transfer="onTransfer"
      @approve="onApprove"
    />
    <submit-btn v-if="!applyId" @submit="submit" />

    <!-- 驳回弹窗 -->
    <Dialog v-if="showReject" @close-popup="closePopup">
      <template #title>
        <text class="dialog-title">确定要驳回吗?</text>
      </template>
      <template #content>
        <wd-textarea v-model="rejectReason" placeholder="请填写理由" />
        <ButtonGroup
          :show-reject="showReject"
          type="error"
          @close-popup="closePopup"
        />
      </template>
    </Dialog>

    <!-- 转办弹窗 -->
    <Dialog v-if="showTransfer" @close-popup="closeTransferPopup">
      <template #title>
        <text class="dialog-title">请选择转办人</text>
      </template>
      <template #content>
        <wd-picker
          v-model="value"
          :columns="columns"
          @confirm="handleConfirm1"
        />
        <ButtonGroup
          :show-reject="showTransfer"
          type="primary"
          @close-popup="closeTransferPopup"
        />
      </template>
    </Dialog>

    <!-- 通过弹窗 -->
    <Dialog v-if="showApproval" @close-popup="closeApprovalPopup">
      <template #title>
        <text class="dialog-title">确定要通过吗?</text>
      </template>
      <template #content>
        <text class="text-sm text-#a3a8b9">抄送人(选填)</text>
        <wd-picker
          v-model="value"
          :columns="columns"
          @confirm="handleConfirm1"
        />
        <ButtonGroup
          :show-reject="showApproval"
          type="success"
          @close-popup="closeApprovalPopup"
          @confirm="confirmApproval"
        />
      </template>
    </Dialog>
  </view>
</template>

<style lang="scss" scoped>
page {
  height: 100%;
  background-color: #f5f5f5;
}

.container {
  display: flex;
  flex-direction: column;
  height: 100vh;
  background-color: #f5f5f5;
}

/* 内容区域 */
.content {
  flex: 1;
  padding: 20rpx 32rpx;
  max-width: 750rpx;
  margin: 0 auto;

  &.has-submit-btn {
    padding-bottom: 140rpx;
  }
}

/* 表单部分 */
.form-section {
  margin-bottom: 24rpx;
  background-color: #fff;
  border-radius: 12rpx;
  padding: 32rpx;
  box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.04);
  width: 690rpx;
  box-sizing: border-box;
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24rpx;
}

.section-title {
  font-size: 32rpx;
  font-weight: 600;
  color: #1f2937;
}

.required {
  color: #ef4444;
  margin-left: 4rpx;
}

.form-row {
  margin-bottom: 24rpx;

  &:last-child {
    margin-bottom: 0;
  }
}

/* 申请单号行 */
.application-number-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.form-label {
  display: block;
  font-size: 28rpx;
  color: #374151;
  margin-bottom: 12rpx;
  font-weight: 500;
}

.form-value {
  font-size: 28rpx;
  color: #1f2937;
  font-weight: 600;
}

.form-input {
  width: 100%;
  height: 80rpx;
  border: 1px solid #d1d5db;
  border-radius: 8rpx;
  padding: 0 16rpx;
  font-size: 28rpx;
  color: #1f2937;
  background-color: #fff;
  box-sizing: border-box;

  &:focus {
    border-color: #3b82f6;
    outline: none;
  }
}

.picker {
  width: 100%;
  height: 80rpx;
  border: 1px solid #d1d5db;
  border-radius: 8rpx;
  padding: 0 16rpx;
  font-size: 28rpx;
  color: #1f2937;
  background-color: #fff;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-sizing: border-box;
}

/* 两列布局 */
.form-grid {
  display: flex;
  gap: 16rpx;
  margin-bottom: 24rpx;

  .form-row {
    flex: 1;
    margin-bottom: 0;
  }
}

/* 开关行 */
.switch-row {
  display: flex;
  align-items: center;
  justify-content: space-between;

  .form-label {
    margin-bottom: 0;
  }
}

/* 车辆信息 */
.vehicle-info {
  margin-top: 24rpx;
  padding-top: 24rpx;
  border-top: 1px solid #e5e7eb;
}

.license-plate-item {
  display: flex;
  align-items: center;
  margin-bottom: 16rpx;
  gap: 16rpx;
}

/* 工具信息 */
.tools-info {
  margin-top: 24rpx;
  padding-top: 24rpx;
  border-top: 1px solid #e5e7eb;
}

.tool-item {
  background-color: #f9fafb;
  border-radius: 8rpx;
  padding: 24rpx;
  margin-bottom: 16rpx;
  position: relative;
  border: 1px solid #e5e7eb;
}

.delete-tool {
  position: absolute;
  top: 16rpx;
  right: 16rpx;
  cursor: pointer;
}

/* 员工清单 */
.import-btn {
  display: flex;
  align-items: center;
  gap: 8rpx;
  color: #3b82f6;
  font-size: 28rpx;
  cursor: pointer;
}

.uploaded-file {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background-color: #f0f9ff;
  border: 1px solid #bae6fd;
  border-radius: 8rpx;
  padding: 16rpx;
  margin-bottom: 16rpx;
}

.file-info {
  display: flex;
  align-items: center;
  gap: 12rpx;
}

.file-name {
  font-size: 28rpx;
  color: #374151;
  max-width: 400rpx;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.download-btn {
  display: flex;
  align-items: center;
  gap: 8rpx;
  color: #3b82f6;
  font-size: 28rpx;
  cursor: pointer;
}

.employee-list {
  margin-bottom: 24rpx;
}

.employee-card {
  background-color: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 8rpx;
  padding: 24rpx;
  margin-bottom: 16rpx;
  position: relative;
}

.delete-employee {
  position: absolute;
  top: 16rpx;
  right: 16rpx;
  cursor: pointer;
}

.upload-area {
  height: 160rpx;
  border: 2rpx dashed #d1d5db;
  border-radius: 8rpx;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background-color: #f9fafb;
  cursor: pointer;
  transition: all 0.3s ease;

  &:hover {
    border-color: #3b82f6;
    background-color: #f0f9ff;
  }
  &.uploading {
    border-color: #3b82f6;
    background-color: #f0f9ff;
    pointer-events: none;
  }
}

.upload-text {
  font-size: 24rpx;
  color: #6b7280;
  margin-top: 8rpx;
  text-align: center;
}

.loading-spinner {
  .rotating {
    animation: spin 1s linear infinite;
  }
}
@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}
.insurance-preview {
  position: relative;
  height: 160rpx;
  border-radius: 8rpx;
  overflow: hidden;
  border: 1px solid #e5e7eb;
  cursor: pointer;
}

.insurance-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.2s ease;

  &:active {
    transform: scale(0.98);
  }
}

/* 图片关闭按钮 - 统一样式 */
.image-close-btn {
  position: absolute;
  top: 8rpx;
  right: 8rpx;
  width: 28rpx;
  height: 28rpx;
  background-color: rgba(0, 0, 0, 0.6);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  cursor: pointer;
  transition: all 0.2s ease;
  z-index: 10;

  &:hover {
    background-color: rgba(0, 0, 0, 0.8);
    transform: scale(1.1);
  }

  &:active {
    transform: scale(0.95);
  }
}

/* 图片操作按钮覆盖层 - 保留用于向后兼容 */
.image-overlay {
  position: absolute;
  top: 0;
  right: 0;
  display: flex;
  gap: 8rpx;
  padding: 8rpx;
  background: linear-gradient(135deg, transparent 0%, rgba(0, 0, 0, 0.1) 100%);
}

.action-btn {
  width: 32rpx;
  height: 32rpx;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 16rpx;
  cursor: pointer;
  transition: all 0.2s ease;

  &.delete-btn {
    background-color: rgba(239, 68, 68, 0.8);

    &:hover {
      background-color: rgba(220, 38, 38, 0.9);
      transform: scale(1.1);
    }
  }

  &.reupload-btn {
    background-color: rgba(59, 130, 246, 0.8);

    &:hover {
      background-color: rgba(37, 99, 235, 0.9);
      transform: scale(1.1);
    }
  }
}

/* 预览提示 */
.preview-tip {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(transparent, rgba(0, 0, 0, 0.6));
  color: white;
  text-align: center;
  padding: 8rpx;
  font-size: 20rpx;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.insurance-preview:hover .preview-tip {
  opacity: 1;
}

/* 错误提示 */
.error-tip {
  margin-top: 8rpx;
  padding: 8rpx 12rpx;
  background-color: #fee2e2;
  border: 1px solid #fecaca;
  border-radius: 4rpx;
  text-align: center;

  text {
    color: #dc2626;
    font-size: 22rpx;
  }
}

/* 移除原来不需要的样式 */
.file-input {
  display: none;
}

.add-employee-btn {
  width: 100%;
  height: 80rpx;
  background-color: #3b82f6;
  color: #fff;
  border: none;
  border-radius: 8rpx;
  font-size: 28rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8rpx;
  cursor: pointer;

  &:hover {
    background-color: #2563eb;
  }
}

/* 审核信息 */
.approval-card {
  background-color: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8rpx;
  padding: 20rpx;
  margin-bottom: 24rpx;
  margin-top: 10rpx;

  &:last-child {
    margin-bottom: 0;
  }
}

.approval-title {
  display: block;
  font-size: 30rpx;
  font-weight: 500;
  color: #1f2937;
  margin-bottom: 16rpx;
}

.approval-checkbox {
  display: flex;
  align-items: center;
  cursor: pointer;

  text {
    font-size: 28rpx;
    color: #374151;
    margin-left: 12rpx;
  }
}

/* 底部按钮 */
.footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 120rpx;
  background-color: #fff;
  box-shadow: 0 -2rpx 8rpx rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20rpx;
  gap: 16rpx;
  z-index: 10;
}

.footer-btn {
  flex: 1;
  height: 80rpx;
  border-radius: 8rpx;
  font-size: 28rpx;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  cursor: pointer;

  &.reject-btn {
    background-color: #ef4444;
    color: #fff;

    &:hover {
      background-color: #dc2626;
    }
  }

  &.transfer-btn {
    background-color: #f59e0b;
    color: #fff;

    &:hover {
      background-color: #d97706;
    }
  }

  &.approve-btn {
    background-color: #10b981;
    color: #fff;

    &:hover {
      background-color: #059669;
    }
  }
}

/* 添加按钮 */
.add-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8rpx;
  color: #3b82f6;
  font-size: 28rpx;
  margin-top: 16rpx;
  padding: 12rpx;
  border: 1px dashed #3b82f6;
  border-radius: 8rpx;
  cursor: pointer;

  &:hover {
    background-color: #f0f9ff;
  }
}

/* 工具类 */
.flex-1 {
  flex: 1;
}

.ml-16rpx {
  margin-left: 16rpx;
}

.cursor-pointer {
  cursor: pointer;
}

/* 响应式调整 */
@media (max-width: 750rpx) {
  .form-grid {
    flex-direction: column;
    gap: 0;

    .form-row {
      margin-bottom: 24rpx;
    }
  }

  .footer {
    padding: 16rpx;
    gap: 12rpx;
  }

  .footer-btn {
    font-size: 24rpx;
  }
}

.excel-upload-container {
  margin-bottom: 30rpx;
}

.excel-upload-progress {
  height: 100rpx;
  border: 2rpx solid #3b82f6;
  border-radius: 8rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f0f9ff;
  margin-bottom: 15rpx;
}

.progress-content {
  display: flex;
  align-items: center;
  gap: 12rpx;
}

.progress-text {
  font-size: 26rpx;
  color: #3b82f6;
  font-weight: 500;
}

.excel-upload-area {
  height: 100rpx;
  border: 2rpx dashed #d9d9d9;
  border-radius: 8rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #fafafa;
  gap: 15rpx;
  cursor: pointer;
  transition: all 0.3s ease;

  &:hover {
    border-color: #3b82f6;
    background: #f0f9ff;
  }
}

.upload-icon {
  font-size: 28rpx;
  color: #999;
}

.upload-text {
  font-size: 26rpx;
  color: #666;
}

.excel-file-display {
  border: 2rpx solid #e8e8e8;
  border-radius: 8rpx;
  padding: 20rpx;
  background: #f9f9f9;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.file-info {
  display: flex;
  align-items: center;
  gap: 15rpx;
}

.file-icon {
  font-size: 28rpx;
  color: #52c41a;
}

.file-name {
  font-size: 28rpx;
  color: #333;
}

.file-actions {
  display: flex;
  gap: 15rpx;
}

.download-btn,
.delete-btn {
  padding: 8rpx 15rpx;
  border-radius: 4rpx;
  font-size: 24rpx;
  cursor: pointer;
}

.download-btn {
  background: #007aff;
  color: #fff;
}

.delete-btn {
  background: #ff4d4f;
  color: #fff;
}

.guard-section {
  margin-bottom: 30rpx;

  &:last-of-type {
    margin-bottom: 20rpx;
  }
}

.section-label {
  font-size: 28rpx;
  color: #333;
  font-weight: 500;
  margin-bottom: 15rpx;
  display: block;
}

.info-row {
  display: flex;
  align-items: center;
  margin-bottom: 15rpx;
}

.info-label {
  font-size: 26rpx;
  color: #666;
  min-width: 180rpx;
}

.info-value {
  font-size: 26rpx;
  color: #333;
}

.guard-input {
  width: 100%;
  height: 60rpx;
  border: 2rpx solid #e8e8e8;
  border-radius: 6rpx;
  padding: 0 15rpx;
  font-size: 26rpx;
  margin-bottom: 15rpx;
  background: #fff;
}

.upload-section {
  margin-top: 15rpx;
}

.upload-label {
  font-size: 26rpx;
  color: #333;
  margin-bottom: 10rpx;
  display: block;
}

.guard-upload-area {
  height: 80rpx;
  border: 2rpx dashed #d9d9d9;
  border-radius: 6rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #fafafa;
  gap: 10rpx;
  margin-bottom: 15rpx;
}

.upload-icon {
  font-size: 24rpx;
  color: #999;
}

.upload-text {
  font-size: 24rpx;
  color: #666;
}

.guard-checkbox {
  display: flex;
  align-items: center;
  margin-top: 20rpx;
}

.checkbox-text {
  font-size: 26rpx;
  color: #333;
  margin-left: 10rpx;
}
/* 如果需要区分离厂审核的特殊样式 */
.guard-exit-section {
  .info-label {
    min-width: 220rpx; /* 稍微增加宽度适应"临时通行证号："文字 */
  }
}

/* 离厂确认复选框的特殊间距 */
.exit-confirmation {
  margin-top: 25rpx;
  padding-top: 20rpx;
  border-top: 1rpx solid #f0f0f0;
}

/* Excel文件信息显示样式 */
.excel-file-info {
  border: 2rpx solid #e8e8e8;
  border-radius: 8rpx;
  padding: 20rpx;
  background: #f9f9f9;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15rpx;
  cursor: pointer;
  transition: all 0.3s ease;

  &:hover {
    border-color: #3b82f6;
    background: #f0f9ff;
  }

  &:active {
    transform: scale(0.98);
  }
}

.file-display {
  display: flex;
  align-items: center;
  gap: 12rpx;
  flex: 1;
}

.file-icon {
  font-size: 28rpx;
  color: #52c41a;
}

.file-name {
  font-size: 26rpx;
  color: #333;
  font-weight: 500;
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.download-indicator {
  display: flex;
  align-items: center;
  gap: 8rpx;
  color: #3b82f6;
}

.download-text {
  font-size: 24rpx;
  color: #3b82f6;
}

/* 无文件占位样式 */
.no-file-placeholder {
  border: 2rpx dashed #d9d9d9;
  border-radius: 8rpx;
  padding: 20rpx;
  background: #fafafa;
  text-align: center;
  margin-bottom: 15rpx;
}

.placeholder-text {
  font-size: 24rpx;
  color: #999;
}

/* 图片预览容器样式 */
.image-preview-container {
  position: relative;
  height: 160rpx;
  border-radius: 8rpx;
  overflow: hidden;
  border: 1px solid #e5e7eb;
  cursor: pointer;
  margin-bottom: 15rpx;
}

.preview-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.2s ease;

  &:active {
    transform: scale(0.98);
  }
}

/* 上传区域loading状态 */
.guard-upload-area.uploading {
  border-color: #3b82f6;
  background: #f0f9ff;
  pointer-events: none;
}

/* 上传区域禁用状态 */
.guard-upload-area.disabled {
  border-color: #d1d5db;
  background: #f9fafb;
  opacity: 0.6;
  cursor: not-allowed;
  pointer-events: none;

  .upload-text {
    color: #9ca3af;
  }

  .upload-icon {
    opacity: 0.5;
  }
}
</style>

/* 已审批节点样式 */ .approved-node { background-color: #f0f9ff; border: 1px
solid #bae6fd; opacity: 0.8; } .approval-status { font-size: 24rpx; color:
#10b981; font-weight: normal; margin-left: 8rpx; }
