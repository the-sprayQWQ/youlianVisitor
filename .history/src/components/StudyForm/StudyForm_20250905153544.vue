<script lang="ts" setup>
import type * as visitor from '../../interface/visitorApplicationInterface'
import { computed, nextTick, onMounted, ref, watch } from 'vue'
import { getAllDepartment } from '../../api/sys'

const props = defineProps({
  applyId: {
    type: String,
  },
  value: {
    type: Array as PropType<number[]>,
  },
  disabled: {
    type: Boolean,
  },
})

const form = defineModel('form', {
  type: Object,
  required: true,
})

onShow(async () => {
  await getDepartList()
  initializeSelections()
})

// 添加 onMounted 作为备用初始化
onMounted(async () => {
  console.log('组件已挂载，开始初始化...')
  // 如果表单数据已经存在且部门列表为空，则主动获取部门列表
  if (form.value?.ylfkApplicationPage?.visitorDept && departments.value.length === 0) {
    console.log('检测到需要获取部门列表')
    await getDepartList()
    initializeSelections()
  }
  else if (form.value?.ylfkApplicationPage?.visitorDept && departments.value.length > 0) {
    // 如果都已经存在，直接初始化选择
    console.log('数据都已存在，直接初始化')
    initializeSelections()
  }
})

defineExpose({
  getDepartList,
})

const vehicleOptions = ref<visitor.VehicleOption[]>([
  { label: '是', value: '是' },
  { label: '否', value: '否' },
])
const departments = ref<visitor.Department[]>([])
const selectedVehicle = ref<visitor.VehicleOption>(vehicleOptions.value[0])
const selectedDepartment = ref<visitor.Department>()

// 添加计算属性来确保部门名称正确显示
const displayDepartmentName = computed(() => {
  console.log('计算部门显示名称:', {
    selectedDepartment: selectedDepartment.value,
    visitorDept: form.value?.ylfkApplicationPage?.visitorDept,
    departments: departments.value.length,
  })

  // 如果 selectedDepartment 有值，优先使用
  if (selectedDepartment.value?.label) {
    return selectedDepartment.value.label
  }

  // 如果没有，尝试从部门列表中实时查找
  if (form.value?.ylfkApplicationPage?.visitorDept && departments.value.length > 0) {
    const dept = departments.value.find(d => d.value === form.value.ylfkApplicationPage.visitorDept)
    if (dept) {
      // 找到后也更新 selectedDepartment
      selectedDepartment.value = dept
      return dept.label
    }
    return '未知部门'
  }

  return '请选择拜访部门'
})

function onVehicleChange(e: any) {
  selectedVehicle.value = vehicleOptions.value[e.detail.value]
  form.value.ylfkApplicationPage.isCard = vehicleOptions.value[e.detail.value].value
}

function updateParticipantCards(e: any) {
  if (e.target.value === '0') {
    console.log(e.target.value)
    uni.showToast({
      title: '参与人员至少为1',
      icon: 'none',
    })
    e.target.value = 1
  }
  else if (e.target.value > form.value.ylfkApplicationPage.ylfkApplicationUserList.length) {
    const count = e.target.value - form.value.ylfkApplicationPage.ylfkApplicationUserList.length
    const newItem = Array.from({ length: count }, () => ({
      name: '',
      phone: '',
      cardType: '',
      idCard: '',
      visitorNumber: '',
      applicationStatus: '',
      carNumber: '',
      enterTime: '',
      leaveTime: '',
    }))
    form.value.ylfkApplicationPage.ylfkApplicationUserList.push(...newItem)
  }
  else if (e.target.value < form.value.ylfkApplicationPage.ylfkApplicationUserList.length) {
    form.value.ylfkApplicationPage.ylfkApplicationUserList.splice(e.target.value, form.value.ylfkApplicationPage.ylfkApplicationUserList.length - e.target.value)
  }
}

function onDepartmentChange(e: any) {
  selectedDepartment.value = departments.value[e.detail.value]
  form.value.ylfkApplicationPage.visitorDept = selectedDepartment.value.value
}

function formatTimeStamp(timeStamp: number) {
  const date = new Date(timeStamp)
  const year = date.getFullYear()
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  const hours = String(date.getHours()).padStart(2, '0')
  const minutes = String(date.getMinutes()).padStart(2, '0')
  const seconds = String(date.getSeconds()).padStart(2, '0')
  return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`
}

function handleConfirm({ value }) {
  form.value.ylfkApplicationPage.startTime = formatTimeStamp(value[0])
  form.value.ylfkApplicationPage.endTime = formatTimeStamp(value[1])
}

const value = ref<number[]>([])

watch(() => props.value, (newValue) => {
  if (newValue && newValue.length > 0) {
    value.value = newValue
  }
}, { immediate: true })

// 优化监听表单数据变化，同步选择器状态
watch(() => form.value?.ylfkApplicationPage?.visitorDept, (newValue) => {
  console.log('监听到部门ID变化:', newValue)
  if (newValue && departments.value.length > 0) {
    const matchedDepartment = departments.value.find(dept => dept.value === newValue)
    if (matchedDepartment) {
      selectedDepartment.value = matchedDepartment
      console.log('✅ 部门匹配成功:', selectedDepartment.value)
    }
    else {
      console.log('❌ 部门匹配失败，未找到对应部门')
      selectedDepartment.value = null
    }
  }
  else if (newValue && departments.value.length === 0) {
    // 如果有部门ID但还没有部门列表，主动获取
    getDepartList()
  }
}, { immediate: true })

// 监听部门列表变化
watch(() => departments.value, (newDepartments) => {
  console.log('监听到部门列表变化:', newDepartments.length)
  if (newDepartments.length > 0 && form.value?.ylfkApplicationPage?.visitorDept) {
    initializeSelections()
  }
}, { immediate: true })

watch(() => form.value?.ylfkApplicationPage?.isCard, (newValue) => {
  if (newValue) {
    const matchedVehicle = vehicleOptions.value.find(option => option.value === newValue)
    if (matchedVehicle) {
      selectedVehicle.value = matchedVehicle
    }
  }
}, { immediate: true })

// 优化初始化选择器状态
function initializeSelections() {
  console.log('=== 初始化选择器状态 ===')

  // 初始化车辆选择
  if (form.value?.ylfkApplicationPage?.isCard) {
    const matchedVehicle = vehicleOptions.value.find(
      option => option.value === form.value.ylfkApplicationPage.isCard,
    )
    if (matchedVehicle) {
      selectedVehicle.value = matchedVehicle
      console.log('✅ 车辆选择初始化成功:', selectedVehicle.value)
    }
  }

  // 初始化部门选择
  if (form.value?.ylfkApplicationPage?.visitorDept && departments.value.length > 0) {
    const matchedDepartment = departments.value.find(
      dept => dept.value === form.value.ylfkApplicationPage.visitorDept,
    )
    if (matchedDepartment) {
      selectedDepartment.value = matchedDepartment
      console.log('✅ 部门选择初始化成功:', selectedDepartment.value)
    }
    else {
      console.log('❌ 部门选择初始化失败，未找到匹配部门')
      selectedDepartment.value = null
    }
  }
  else {
    console.log('⚠️ 部门初始化条件不满足:', {
      hasVisitorDept: !!form.value?.ylfkApplicationPage?.visitorDept,
      hasDepartments: departments.value.length > 0,
    })
  }
}

async function getDepartList() {
  try {
    const res = await getAllDepartment()
    if (res.result) {
      departments.value = res.result.map(item => ({
        label: item.departName,
        value: item.id,
      }))

      console.log('部门列表加载完成:', departments.value)

      // 获取部门列表后，如果表单中已有部门数据，则设置选中状态
      await nextTick()
      if (form.value?.ylfkApplicationPage?.visitorDept) {
        const matchedDepartment = departments.value.find(
          dept => dept.value === form.value.ylfkApplicationPage.visitorDept,
        )
        if (matchedDepartment) {
          selectedDepartment.value = matchedDepartment
          console.log('✅ 获取部门列表后匹配成功:', selectedDepartment.value)
        }
        else {
          console.log('❌ 获取部门列表后匹配失败')
          selectedDepartment.value = null
        }
      }
    }
  }
  catch (error) {
    console.error('获取部门列表失败:', error)
  }
}
</script>

<template>
  <view class="form-section">
    <view class="form-grid">
      <view class="form-item">
        <text class="form-label required">申请人</text>
        <input
          v-model="form.ylfkApplicationPage.user"
          class="form-input"
          type="text"
          placeholder="请输入姓名"
          :disabled="props.disabled"
        >
      </view>
      <view class="form-item">
        <text class="form-label required">联系电话</text>
        <input
          v-model="form.ylfkApplicationPage.phone"
          :disabled="props.disabled"
          class="form-input"
          type="tel"
          placeholder="请输入电话"
        >
      </view>
    </view>

    <view class="form-grid">
      <view class="form-item">
        <text class="form-label required">身份证号</text>
        <input
          v-model="form.ylfkApplicationPage.idCard"
          :disabled="props.disabled"
          class="form-input"
          type="text"
          placeholder="请输入身份证号"
        >
      </view>
      <view class="form-item">
        <text class="form-label required">起止时间</text>
        <view class="calendar-wrapper">
          <wd-datetime-picker
            v-model="value"
            ellipsis
            :close-on-click-modal="false"
            :disabled="props.disabled"
            @confirm="handleConfirm"
          />
        </view>
      </view>
    </view>

    <view class="form-grid">
      <view class="form-item">
        <text class="form-label required">申请单位</text>
        <input
          v-model="form.ylfkApplicationPage.applicationDept"
          class="form-input"
          type="text"
          :disabled="props.disabled"
          placeholder="请输入单位名称"
        >
      </view>
      <view class="form-item">
        <text class="form-label required">拜访部门</text>
        <picker
          mode="selector"
          :range="departments"
          range-key="label"
          :disabled="props.disabled"
          @change="onDepartmentChange"
        >
          <view class="select-input">
            <text>{{ displayDepartmentName }}</text>
          </view>
        </picker>
      </view>
    </view>

    <view class="form-grid">
      <view class="form-item">
        <text class="form-label required">联系人</text>
        <input
          v-model="form.ylfkApplicationPage.visitorUser"
          class="form-input"
          type="text"
          placeholder="请输入联系人"
          :disabled="props.disabled"
        >
      </view>
      <view class="form-item">
        <text class="form-label required">联系人电话</text>
        <input
          v-model="form.ylfkApplicationPage.visitorPhone"
          class="form-input"
          type="tel"
          :disabled="props.disabled"
          placeholder="请输入电话"
        >
      </view>
    </view>

    <view class="form-grid">
      <view class="form-item">
        <text class="form-label">交流内容</text>
        <input
          v-model="form.ylfkApplicationPage.remark"
          :disabled="props.disabled"
          class="form-input"
          type="text"
          placeholder="请输入交流内容"
        >
      </view>
      <view class="form-item">
        <text class="form-label required">参与人数</text>
        <input
          v-model="form.ylfkApplicationPage.joinUserNum"
          :disabled="props.disabled"
          class="form-input"
          type="number"
          placeholder="请输入参与人数"
          @blur="updateParticipantCards"
        >
      </view>
    </view>

    <view class="form-grid">
      <view class="form-item">
        <text class="form-label required">是否有随行车辆</text>
        <picker
          mode="selector"
          :range="vehicleOptions"
          range-key="label"
          :disabled="props.disabled"
          @change="onVehicleChange"
        >
          <view class="select-input">
            <text>{{ selectedVehicle.label }}</text>
          </view>
        </picker>
      </view>
      <view v-if="form.ylfkApplicationPage.isCard === '是'" class="form-item">
        <text class="form-label required">车牌号</text>
        <input
          v-model="form.ylfkApplicationPage.carCode"
          class="form-input"
          type="text"
          placeholder="请输入车牌号"
          :disabled="props.disabled"
        >
      </view>
    </view>

    <view class="form-group" :class="{ 'pb-12': props.applyId === '' }">
      <text class="form-label required">同行人员信息</text>
      <view class="participant-cards">
        <view
          v-for="(participant, index) in form.ylfkApplicationPage.ylfkApplicationUserList"
          :key="index"
          class="participant-card"
        >
          <view class="card-row">
            <text class="form-label required">姓名</text>
            <input
              v-model="participant.name"
              class="form-input"
              type="text"
              placeholder="请输入姓名"
              :disabled="props.disabled"
            >
          </view>
          <view class="card-row">
            <text class="form-label required">身份证号</text>
            <input
              v-model="participant.idCard"
              class="form-input"
              :disabled="props.disabled"
              type="text"
              placeholder="请输入身份证号"
            >
          </view>
        </view>
      </view>
    </view>
  </view>
</template>

<style lang="scss" scoped>
.form {
  &-section {
    padding: 24rpx;
    padding-top: 0;
    padding-bottom: 0;
  }

  &-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16rpx;
  }
  &-row-number {
    display: flex;
    justify-content: space-between;
    // width: 650rpx;
    margin: 0 auto;
    height: 80rpx;
    background-color: #f9fafb;
    border: 1px solid #f9fafb;
    align-items: center;
    border-radius: 20rpx;
    margin-bottom: 10rpx;
    & .form-label {
      font-size: 14px;
      color: #8b97a7;
      margin-left: 20rpx;
    }
    & .form-value {
      font-size: 14px;
      color: #8b97a7;
      margin-right: 20rpx;
    }
  }

  &-label {
    font-size: 14px;
    color: #4e5969;
  }

  &-value {
    font-size: 14px;
  }

  &-group {
    margin-bottom: 24rpx;
  }

  &-grid {
    display: flex;
    gap: 20rpx; // 保持你原有的40rpx间距
    margin-bottom: 16rpx;
  }

  &-item {
    flex: 1;
    .calendar-wrapper {
      width: 340rpx;
    }
  }

  &-input {
    height: 64rpx;
    border: 1px solid #e5e7eb;
    border-radius: 4rpx;
    padding: 0 24rpx;
    font-size: 14px;
    color: #1d2129;
    width: 100%;
    box-sizing: border-box; // 确保padding不影响总宽度
    z-index: 1;
  }
}
.select {
  &-wrapper {
    position: relative;
  }

  &-input {
    height: 64rpx;
    border: 1px solid #e5e7eb;
    border-radius: 4rpx;
    padding: 0 24rpx;
    font-size: 14px;
    color: #1d2129;
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    box-sizing: border-box; // 确保宽度一致
  }
}
.card-row {
  margin-bottom: 16rpx;

  &:last-child {
    margin-bottom: 0;
  }
}
.participant {
  &-cards {
    margin-top: 16rpx;
  }

  &-card {
    background-color: #f5f7fa;
    border-radius: 8rpx;
    padding: 24rpx;
    margin-bottom: 16rpx;
  }
}
.required {
  &::after {
    content: '*';
    color: #ff4d4f;
    margin-left: 4rpx;
  }
}
</style>
